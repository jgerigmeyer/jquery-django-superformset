/*! Django Superformset - v1.0.0 - 2014-02-19
* https://github.com/jgerigmeyer/jquery-django-superformset
* Based on jQuery Formset 1.1r14, by Stanislaus Madueke
* Original Portions Copyright (c) 2009 Stanislaus Madueke
* Modifications Copyright (c) 2014 Jonny Gerig Meyer; Licensed BSDv3 */
!function(a){"use strict";var b={init:function(c){var d={},e=d.opts=a.extend({},a.fn.superformset.defaults,c),f=d.wrapper=a(this),g=d.rows=f.find(e.rowSel),h=d.container=g.closest(e.containerSel);d.totalForms=f.find('input[id$="-'+e.prefix+'-TOTAL_FORMS"]'),d.maxForms=f.find('input[id$="-'+e.prefix+'-MAX_NUM_FORMS"]');var i=d.tpl=h.find(e.formTemplate).clone(!0);return h.find(e.formTemplate).find("[required], .required").removeAttr("required").removeData("required-by").addClass("required"),i.removeAttr("id").find("input, select, textarea").filter("[required]").addClass("required").removeAttr("required"),b.addDeleteTrigger(i,e.canDelete,d),b.addInsertAboveTrigger(i,d),g.each(function(){var c=a(this);b.addDeleteTrigger(c,e.canDelete&&!e.deleteOnlyNew,d),b.addInsertAboveTrigger(c,d),b.watchForChangesToOptionalIfEmptyRow(c,d)}),e.autoAdd||b.activateAddTrigger(d),e.alwaysShowExtra&&e.autoAdd&&(b.autoAddRow(d),f.closest("form").submit(function(){a(this).find(e.rowSel).filter(".extra-row").find("input, select, textarea").each(function(){a(this).removeAttr("name")})})),f},activateAddTrigger:function(c){var d,e=c.opts;d=c.addButton=c.wrapper.find(e.addTriggerSel).length?c.wrapper.find(e.addTriggerSel):a(e.addTrigger).appendTo(c.wrapper),b.showAddButton(c)||d.hide(),d.click(function(d){var f=a(this),g=parseInt(c.totalForms.val(),10),h=c.tpl.clone(!0).addClass("new-row");h.find("input, select, textarea").filter(".required").attr("required","required"),e.addAnimationSpeed?h.hide().insertAfter(c.wrapper.find(e.rowSel).last()).animate({height:"toggle",opacity:"toggle"},e.addAnimationSpeed):h.insertAfter(c.wrapper.find(e.rowSel).last()).show(),h.find("input, select, textarea, label").each(function(){b.updateElementIndex(a(this),e.prefix,g)}),b.watchForChangesToOptionalIfEmptyRow(h,c),c.totalForms.val(g+1),b.showAddButton(c)||f.hide(),e.addedCallback&&e.addedCallback(h),d.preventDefault()})},watchForChangesToOptionalIfEmptyRow:function(a,c){var d=c.opts;if(d.optionalIfEmpty&&a.is(d.optionalIfEmptySel)){var e=a.find("input, select, textarea");e.filter("[required], .required").removeAttr("required").data("required-by",d.prefix).addClass("required"),a.data("original-vals",e.serialize()),e.not(d.deleteTriggerSel).change(function(){b.updateRequiredFields(a,c)})}},updateElementIndex:function(a,b,c){var d=new RegExp("("+b+"-(\\d+|__prefix__))"),e=b+"-"+c;a.attr("for")&&a.attr("for",a.attr("for").replace(d,e)),a.attr("id")&&a.attr("id",a.attr("id").replace(d,e)),a.attr("name")&&a.attr("name",a.attr("name").replace(d,e))},showAddButton:function(a){return""===a.maxForms.val()||a.maxForms.val()-a.totalForms.val()>0},addDeleteTrigger:function(c,d,e){var f=e.opts;d?a(f.deleteTrigger).appendTo(c).click(function(c){var d,g,h=a(this).closest(f.rowSel),i=function(c,d){c.eq(d).find("input, select, textarea, label").each(function(){b.updateElementIndex(a(this),f.prefix,d)})},j=function(){for(h.remove(),d=e.wrapper.find(f.rowSel),e.totalForms.val(d.not(".extra-row").length),g=0;g<d.length;g+=1)i(d,g)};f.removeAnimationSpeed?a.when(h.animate({height:"toggle",opacity:"toggle"},f.removeAnimationSpeed)).done(j):j(),f.removedCallback&&f.removedCallback(h),c.preventDefault()}):c.find(f.deleteTriggerSel).change(function(){var b=a(this),c=b.closest(f.rowSel);b.prop("checked")?c.find("[required]").removeAttr("required").addClass("deleted-required"):c.find(".deleted-required").attr("required","required").removeClass("deleted-required")})},addInsertAboveTrigger:function(c,d){var e=d.opts;e.insertAbove&&a(e.insertAboveTrigger).prependTo(c).click(function(c){var f,g,h=a(this).closest(e.rowSel),i=parseInt(d.totalForms.val(),10),j=d.tpl.clone(!0).addClass("new-row"),k=function(c,d){c.eq(d).find("input, select, textarea, label").each(function(){b.updateElementIndex(a(this),e.prefix,d)})};for(j.find("input, select, textarea").filter(".required").attr("required","required"),e.addAnimationSpeed?j.hide().insertBefore(h).animate({height:"toggle",opacity:"toggle"},e.addAnimationSpeed):j.insertBefore(h).show(),f=d.wrapper.find(e.rowSel),d.totalForms.val(i+1),g=0;g<f.length;g+=1)k(f,g);b.watchForChangesToOptionalIfEmptyRow(j,d),b.showAddButton(d)||a(this).hide(),e.addedCallback&&e.addedCallback(j),a(this).blur(),c.preventDefault()})},autoAddRow:function(c){var d=c.opts,e=parseInt(c.totalForms.val(),10),f=c.tpl.clone(!0),g=c.wrapper.find(d.rowSel);d.addAnimationSpeed?f.hide().css("opacity",0).insertAfter(g.last()).addClass("extra-row").animate({height:"toggle",opacity:"0.5"},d.addAnimationSpeed):f.css("opacity",.5).insertAfter(g.last()).addClass("extra-row"),f.find("input, select, textarea, label").one("focus",function(){var e=a(this),g=e.closest(d.rowSel);g.removeClass("extra-row").css("opacity",1),!e.hasClass("required")||d.optionalIfEmpty&&f.is(d.optionalIfEmptySel)||e.attr("required","required"),c.totalForms.val(c.wrapper.find(d.rowSel).not(".extra-row").length),d.deleteOnlyActive&&g.find(d.deleteTriggerSel).fadeIn(),b.showAddButton(c)&&g.is(c.wrapper.find(d.rowSel).last())&&b.autoAddRow(c)}).each(function(){var c=a(this);b.updateElementIndex(c,d.prefix,e),c.filter("[required]").removeAttr("required").addClass("required")}),b.watchForChangesToOptionalIfEmptyRow(f,c),d.deleteOnlyActive&&f.find(d.deleteTriggerSel).hide(),d.addedCallback&&d.addedCallback(f)},updateRequiredFields:function(b,c){var d=c.opts,e=b.find("input, select, textarea"),f=e.filter(function(){return a(this).data("required-by")===d.prefix}),g=e.serialize(),h=b.data("original-vals");g===h?f.removeAttr("required"):f.filter(".required").not(".deleted-required").attr("required","required")},exposeMethods:function(){return b}};a.fn.superformset=function(c){return b[c]?b[c].apply(this,Array.prototype.slice.call(arguments,1)):"object"!=typeof c&&c?void a.error("Method "+c+" does not exist on jQuery.superformset"):b.init.apply(this,arguments)},a.fn.superformset.defaults={prefix:"form",containerSel:"form",rowSel:".dynamic-form",formTemplate:".empty-form .dynamic-form",deleteTrigger:'<a href="#" class="remove-row" title="remove">remove</a>',deleteTriggerSel:".remove-row",addTrigger:'<a href="#" class="add-row" title="add">add</a>',addTriggerSel:null,addedCallback:null,removedCallback:null,addAnimationSpeed:"normal",removeAnimationSpeed:"fast",autoAdd:!1,alwaysShowExtra:!1,deleteOnlyActive:!1,canDelete:!1,deleteOnlyNew:!1,insertAbove:!1,insertAboveTrigger:'<a href="#" class="insert-row" title="insert">insert</a>',optionalIfEmpty:!0,optionalIfEmptySel:'[data-empty-permitted="true"]'}}(jQuery);